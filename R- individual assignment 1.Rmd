---
output: pdf_document
geometry: margin = 0.75in
---

```{r RMarkdown setup., include = FALSE}
knitr::opts_knit$set(root.dir = getwd())
```

```{r, include = FALSE}
library("dplyr")
library("ggplot2")
library("styler")
AC <- read.csv2("input/AC.csv", stringsAsFactors = FALSE, dec = ".")
write.table(AC,"input/AC.txt", quote = T, sep = "\t")
AC <- read.delim("input/AC.txt", stringsAsFactors = FALSE)
answer_backup <- read.delim("input/backup_answer.txt")
```

##### Data Set Information

This assignment concerns a data set called `AC` that contains Energy Rating Data for household appliances (in this case, ACs) from the Australian government (https://www.data.gov.au/dataset/ds-dga-559708e5-480e-4f94-8429-c49571e82761/details). Along with the dataset, there is a data dictionary available that provides some information about what each variable means. This data dictionary will also be published on Canvas. Terms in *italics* refer to information from the codebook.

##### Question 1
Create an object that is a copy of `AC`. In this object, replace all instances of zero in the `Setting_cool` variable with the mean value for the non-NA entries. Create this object with a meaningful name initially, then copy it into an object called `answer1`.

```{r, results = "hide", echo = FALSE}
AC01 <- AC
mean_value <- mean(AC01$Setting_cool, na.rm = TRUE)
AC01$Setting_cool[AC01$Setting_cool == 0] <- mean_value
answer1 <- AC01
```

##### Question 2
Create an object that is a copy of `AC`, but only contains the AC units that have a *tested energy efficiency ratio* for cooling AND heating of at least 4, and omits all columns except for `Brand` and any column with "Star2010" in its name. Create this object with a meaningful name initially, then copy it into an object called `answer2`.

```{r, results = "hide", echo = FALSE}
AC02 <- AC
filter_AC02 <- AC02 %>% 
  filter(EERtestAvg >= 4 & COPtestAvg >= 4) %>%
  select(contains("Star2010") | Brand )
answer2 <- filter_AC02
```

##### Question 3
Create a barplot that shows, per `c_star_mixed` value, the number of ACs (each row counts as 1 AC) in the data set. Only show the ratings >0 and <6. Make sure that there are tickmarks at the integers 1:5. Label x-axis "Energy Rating Label". Store this plot in an object called `answer3`.

```{r, results = "hide", echo = FALSE}
plot03 <- ggplot() +
  geom_bar(data = AC, aes(x = c_star_mixed)) + 
  scale_x_continuous(limits = c(0, 6), 
                     breaks = c(1, 2, 3, 4, 5),
                     name = "Energy Rating Label")
answer3 <- plot03
```


##### Question 4
Create an object that is a copy of `AC`, but shows aggregated data so that each row of the dataframe has the following information (with the specified columns names) for each unique brand of AC: 
`Brand`: Brand name
`NumberOfProducts`: the total number of units of this brand in the dataset
`AvCoolingLabel`: the average *Energy Rating Label for cooling post 2010* for these products (removing NAs)
`AvHeatingLabel`: the average *Energy Rating Label for heating post 2010* for these products (removing NAs)
`AvLabel`: the unweighted average value of the label values in the `AvCoolingLabel` and `AvHeatingLabel` entries for this brand.
Create this object with a meaningful name initially, then copy it into an object called `answer4`.

```{r, results = "hide", echo = FALSE}
AC04 <- AC
aggregated <- AC04 %>%
  group_by(Brand) %>%
  summarise(
    NumberOfProducts = n(), 
    AvCoolingLabel = mean(Star2010_Cool, na.rm = TRUE),
    AvHeatingLabel = mean(Star2010_Heat, na.rm = TRUE)
    ) %>%
  mutate(AvLabel = (AvCoolingLabel + AvHeatingLabel) / 2)
answer4 <- aggregated
```

##### Question 5
Create an object that is a copy of `AC`, but retaining only the rows that have a "MEPS 2011" or "MEPS 2019" entry in the `MEPSComp` variable. With this selection, use the *rename_with* function (look it up) and the function "remove_underscores" supplied in the example script to rename the remaining columns so that any underscore in any column name is replaces with a period. Finally, remove any columns that have "Configuration" (case-insensitive) in their name. Create this object with a meaningful name initially, then copy it into an object called `answer5`.


```{r, results = "hide", echo = FALSE}
AC05 <- AC
remove_underscores <- function(x){
  gsub("_", ".", x, fixed = TRUE)
}
answer5 <- AC05 %>%
  filter(MEPSComp == "MEPS 2011" | MEPSComp == "MEPS 2019") %>%
  rename_with(remove_underscores) %>%
  select(-contains("configuration", ignore.case = TRUE))
```


##### Question 6
Using your answer from Question 4 (or, alternatively, using the file "backup_answer.txt"), retain from the brands that have at least 5 units in the dataset only those with the top 10 highest `AvLabel` scores. Make a scatter plot that shows the `AvCoolingLabel` on the x-axis and the `AvHeatingLabel` on the y-axis. Using a continuous greyscale (i.e from white (low) to black (high) through scaled grey tones), set the dot color to represent `AvLabel` and the size of the dots to scale with the `NumberOfProducts`. Apply the minimal theme and "Viridis_C" color scale and store this plot in an object called `answer6`.

```{r, results = "hide", echo = FALSE}
brands_top10 <- answer4 %>%
  filter(NumberOfProducts >= 5) %>%
  arrange(desc(AvLabel)) %>%
  slice(0:10)

plot06 <- ggplot() +
  geom_point(data = brands_top10, aes(x = AvCoolingLabel, y = AvHeatingLabel, 
                                      color = AvLabel, 
                                      size = NumberOfProducts)) +
  scale_color_continuous(low = "white", high = "black") +
  theme_minimal() +
  scale_color_viridis_c()

answer6 <- plot06
```

##### Question 7
Create a barplot that shows, for "Ducted" and "Non Ducted" AC types (ignoring "Both" in the "Configuration1" entry), the relative proportion (so that the two bars add up to 1) of AC units produced in each (combination of) `Country`. Omit the x-axis and y-axis labels. Store this plot in an object called `answer7`.

```{r, results = "hide", echo = FALSE}
answer7 <- filter(AC, Configuration1 %in% c("Ducted", "Non Ducted")) %>%
  ggplot(aes(x = Configuration1, fill = Country)) +
  geom_bar(position = "fill") +
  scale_x_discrete(name = element_blank()) +
  scale_y_continuous(name = element_blank())
```

##### Question 8
Create a violin plot that shows, for the ACs containing "Multiple split" in their `Configuration2`, the distribution of values for `C.Total.Cool.Rated` per `Configuration1` category, split into different violins by the "Multiple Split" type. Adjust the color legend name to "Multiple Split Type" and omit "Multiple split - " from the legend categories. Adjust the x and y labels to "Indoor Air Distribution" and "Total Cooling Output (kW)", respectively. Store this plot in an object called `answer8`.

```{r, results = "hide", echo = FALSE}
answer8 <- AC %>% 
  filter(grepl("Multiple split", Configuration2))  %>%
  ggplot(aes(x = Configuration1, y = C.Total.Cool.Rated, fill = Configuration2)) +
  geom_violin() +
  scale_fill_discrete(breaks = c("Multiple split - Fixed head","Multiple split - VRF"), 
                      labels = c("Fixed Head", "VRF")) +
  labs(fill = "Multiple Split Type", y = "Total Cooling Output (kW)", x = "Indoor Air Distribution")

```

##### Question 9
Create an object that holds, in a named list, two different types of information about all AC units that are produced in China and in China+other countries):
(1) a tibble named "Heating" with a variable called `Mean.APC` with the average power consumption for heating (`H.Total.Heat.Rated`) split by `Phase` for all ACs with such a known APC rating 
(2) a named vector called "Refrigerant" with names of the refrigerants used, sorted from most used to least used. 
Store this object as `answer9`.

```{r, results = "hide", echo = FALSE, warning= F}
chinese_AC <- AC[grep("China", AC$Country, ignore.case = TRUE), ]
## incorrectly stated "sold in" in the question -> also count correct, need to update in answer model

heating <- chinese_AC %>%
  group_by(Phase,) %>%
  summarize(Mean.APC = mean(H.Total.Heat.Rated, na.rm = T),  .groups = "keep")

refrigerants <- chinese_AC %>%
  group_by(Refrigerant) %>%
  summarise(n = n(), .groups = "keep") %>%
  arrange(desc(n)) %>%
  select(-n)

answer9 <-
  list(Heating = heating, Refrigerant = refrigerants$Refrigerant)
```

##### Question 10.
Create a plot that looks as much as possible like the one below. You can use ggsave(plot = answer10, width = 6, height = 4, filename = "test.pdf") to check the dimensions (no need to include this function in your answer). Store the plot as `answer10`.
   
   
   

```{r, echo = FALSE, fig.width = 6, fig.height = 4, warning= FALSE, out.width = '100%', out.heigth = '100%'}

answer10 <- AC %>%
  filter(outdoortype != "") %>%
  ggplot(aes(x = AnnualOutputCOP, fill = outdoortype)) +
  geom_histogram(bins = 30) +
  scale_x_continuous(name = "COP", limits = c(2.5,6), breaks = seq(2.5,6,0.5)) +
  scale_y_continuous(name = "Number of AC Units", breaks = c(0,400)) + 
  labs(fill = "Outdoor Type") +
  theme_linedraw() +
  theme(panel.grid.minor = element_blank()) +
  ggtitle("Distribution of heating energy efficiency (kW/kW) per Outdoor Type")

```
